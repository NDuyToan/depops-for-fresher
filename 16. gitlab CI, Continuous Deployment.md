# 16. Gitlab CI/Continuous Deployment.md

## CÃ i cÃ´ng cá»¥ gitlab runner

- á»Ÿ server dev (khÃ´ng pháº£i server gitlab), tiáº¿n hÃ nh cÃ i

```
$ apt-get update

$ curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | bash

$ apt-get install gitlab-runner

$ apt-cache madison gitlab-runner (khÃ´ng cáº§n) - Hiá»ƒn thá»‹ táº¥t cáº£ cÃ¡c phiÃªn báº£n gitlab-runner cÃ³ thá»ƒ cÃ i tá»« repo hiá»‡n táº¡i

$ gitlab-runner -version
```

- cÅ©ng giá»‘ng nhÆ° nginx, thÃ¬ gitlab runner cÅ©ng cÃ³ 1 user riÃªng, má»Ÿ `vi /etc/passwd` Ä‘á»ƒ xem: `/home/gitlab-runner:/bin/bash`

## Káº¿t ná»‘i gitlab-runner vá»›i dá»± Ã¡n

- vÃ o dá»± Ã¡n á»Ÿ trÃªn trang web gitlab, vÃ o **Setting -> CI/CD-> Runners-> Expand**
- quay láº¡i dev server, cháº¡y lá»‡nh `gitlab-runner register`
- Ä‘iá»n cÃ¡c thÃ´ng tin:
  - url gitlab
  - token
  - description: nÃªn Ä‘á»ƒ giá»‘ng tÃªn server
  - tags (Ä‘Ã¢y lÃ  runner): Ä‘á»ƒ giá»‘ng tÃªn server luÃ´n
  - optional: bá» qua cÅ©ng Ä‘Æ°á»£c
- tiáº¿p theo lÃ  Ä‘áº¿n pháº§n executor, á»Ÿ Ä‘Ã¢y lÃ  ngÆ°á»i má»›i thÃ¬ chá»‰ cáº§n quan tÃ¢m Ä‘áº¿n shell, docker thÃ´i, shell - tá»©c lÃ  nhá»¯ng lá»‡nh á»Ÿ trong nÃ y sáº½ cháº¡y á»Ÿ trÃªn server luÃ´n, cÃ²n docker thÃ¬ táº¡o ra 1 mÃ´i trÆ°á»ng Ä‘á»™c láº­p => giá» ta sáº½ chá»n lÃ  shell
  => cáº¥u hÃ¬nh thÃ nh cÃ´ng táº¡i file `/etc/gitlab-runner/config.toml`, má»Ÿ lÃªn vÃ  sá»­a dÃ²ng `concurrent=4`, sá»­a thÃ nh 4, tá»©c lÃ  con runner nÃ y cÃ³ thá»ƒ cháº¡y 4 project khÃ¡c nhau
- khá»Ÿi Ä‘á»™ng runner lÃªn: ` nohup gitlab-runner  run  --working-directory /home/gitlab-runner/ --config  /etc/gitlab-runner/config.toml  --service gitlab-runner  --user gitlab-runner 2>&1 &`

```2>&1 â€“ gom log lá»—i vÃ  log chuáº©n vá» má»™t chá»—

1 = stdout (log bÃ¬nh thÆ°á»ng)

2 = stderr (log lá»—i)

2>&1 nghÄ©a lÃ :

ğŸ‘‰ Chuyá»ƒn log lá»—i (stderr) sang cÃ¹ng nÆ¡i vá»›i log chuáº©n (stdout)

Nhá» váº­y log chÃ­nh xÃ¡c táº­p trung má»™t nÆ¡i (thÆ°á»ng lÃ  file nohup.out).

& â€“ cháº¡y ná»n (background)

KÃ½ hiá»‡u nÃ y lÃ m cho command cháº¡y:

trong background

tráº£ láº¡i terminal cho báº¡n
```

- ps -ef| grep gitlab-runner: Ä‘á»ƒ xem cÃ¡c progress Ä‘ang cháº¡y
- quay láº¡i trang gitlab, ta tháº¥y 1 runner Ä‘ang cháº¡y, báº¥m vÃ o edit Ä‘á»ƒ update cÃ¡c info
  - Protected: náº¿u chá»n cÃ¡i nÃ y thÃ¬ nhá»¯ng nhÃ¡nh nÃ o dc protect thÃ¬ má»›i Ä‘Æ°á»£c cháº¡y thÃ´i (thÃ´ng thÆ°á»ng thÃ¬ ta koong chá»n)
  - Lock to-curent projects (bá» chá»n Ä‘i): náº¿u chá»n thÃ¬ con runner nÃ y chá»‰ cháº¡y Ä‘Æ°á»£c 1 dá»± Ã¡n thÃ´i

## Viáº¿t ká»‹ch báº£n

- táº¡o file .gitlab-ci.yml

```
stages:
    - build
    - deploy
    - checklog
build:
    stage: build
    script:
        - whoami
        - pwd
        - ls
```

- tuy nhiÃªn lÃºc nÃ y chÆ°a cháº¡y Ä‘Æ°á»£c, do chÆ°a khai bÃ¡o con runner, do Ä‘Ã³ cáº§n sá»­a láº¡i file gitlab-ci.yml

```
tags:
        - ubuntu-server
```
